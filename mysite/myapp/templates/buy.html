{% load static %}
<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <title>Buy Subscription</title>

  {% if not free %}
  <script src="https://checkout.razorpay.com/v1/checkout.js"></script>
  {% endif %}

  <script>
    function getCookie(name) {
      let cookieValue = null;
      if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
          const cookie = cookies[i].trim();
          if (cookie.substring(0, name.length + 1) === (name + '=')) {
            cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
            break;
          }
        }
      }
      return cookieValue;
    }
    const csrftoken = getCookie('csrftoken');
  </script>

  <style>
    body {
      background: radial-gradient(circle at top left, #0d102f 0%, #040717 80%);
      color: #fff;
      display: flex;
      align-items: center;
      justify-content: center;
      height: 100vh;
      font-family: "Poppins", sans-serif;
      margin: 0;
      overflow: hidden;
    }

    .card {
      background: rgba(15, 20, 50, 0.9);
      padding: 40px;
      border-radius: 18px;
      width: 400px;
      text-align: center;
      box-shadow: 0 0 25px rgba(0, 136, 255, 0.3);
      border: 1px solid rgba(0, 136, 255, 0.2);
      backdrop-filter: blur(8px);
      transition: 0.3s;
    }

    .card:hover {
      box-shadow: 0 0 40px rgba(0, 136, 255, 0.6);
      transform: translateY(-5px);
    }

    h2 {
      color: #00b8ff;
      margin-bottom: 10px;
      font-size: 1.6rem;
      font-weight: 600;
    }

    p {
      color: #b0c7e6;
      margin-bottom: 25px;
      font-size: 0.95rem;
    }

    input {
      width: 95%;
      padding: 12px;
      margin-top: 12px;
      border: none;
      border-radius: 10px;
      font-size: 1rem;
      background: rgba(255, 255, 255, 0.08);
      color: #fff;
      outline: none;
      transition: all 0.3s;
    }

    input:focus {
      background: rgba(255, 255, 255, 0.15);
      box-shadow: 0 0 8px rgba(0, 184, 255, 0.5);
    }

    button {
      width: 94%;
      padding: 14px;
      margin-top: 20px;
      border: none;
      border-radius: 10px;
      background: linear-gradient(90deg, #0066ff, #00c6ff);
      color: white;
      cursor: pointer;
      font-weight: 600;
      font-size: 1rem;
      transition: all 0.3s ease;
      box-shadow: 0 0 15px rgba(0, 102, 255, 0.4);
    }

    button:hover {
      transform: scale(1.03);
      box-shadow: 0 0 25px rgba(0, 198, 255, 0.6);
    }

    .toast {
      position: fixed;
      top: 25px;
      right: 25px;
      background: linear-gradient(90deg, #00b8ff, #007bff);
      color: #fff;
      padding: 14px 22px;
      border-radius: 8px;
      font-weight: 500;
      opacity: 0;
      transform: translateY(-20px);
      transition: all 0.4s ease;
      z-index: 1000;
    }

    .toast.show {
      opacity: 1;
      transform: translateY(0);
    }

    .toast.error {
      background: linear-gradient(90deg, #ff4b2b, #ff416c);
    }

    .toast.success {
      background: linear-gradient(90deg, #00ff88, #00c6ff);
    }
  </style>




</head>

<body>
  <div class="card">
    <h2 id="planTitle">{{ plan }}</h2>
    <p>Complete your subscription</p>

    <form id="paymentForm">
      <input type="text" id="name" placeholder="Full Name">
      <input type="email" id="email" placeholder="Email">
      <input type="text" id="phone" placeholder="Phone Number" maxlength="14">
      <input type="company" id="company" placeholder="Company">


      {% if free %}
      <!-- FREE PLAN → No Amount Field -->
      <button type="button" id="freeBtn">Submit</button>

      {% else %}
      <input type="number" id="amount" value="{{ amount }}" readonly>
      <button type="button" id="payBtn">Pay ₹{{ amount }}</button>
      {% endif %}
    </form>
  </div>

  <div id="toast" class="toast"></div>

<script>
/* ============================================================
   TOAST MESSAGE UTILITY
============================================================ */
function showToast(message, type = "info") {
  const toast = document.getElementById("toast");
  toast.textContent = message;
  toast.className = "toast show " + type;
  setTimeout(() => { toast.className = "toast"; }, 3000);
}

/* ============================================================
   FORM ELEMENTS
============================================================ */
const freePlan = "{{ free }}" === "True";
const plan = "{{ plan }}";

const phoneInput = document.getElementById("phone");
const emailInput = document.getElementById("email");
const nameInput = document.getElementById("name");
const companyInput = document.getElementById("company");
const submitBtn = freePlan ? document.getElementById("freeBtn") : document.getElementById("payBtn");

/* ============================================================
   VALIDATION
============================================================ */
function validateForm() {
  const name = nameInput.value.trim();
  const company = companyInput.value.trim();
  const email = emailInput.value.trim();
  const phone = phoneInput.value.trim();

  const phoneValid = /^[0-9]{10,14}$/.test(phone);
  const emailValid = /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email);

  if (email && !emailValid) showToast("Enter valid Email ID", "error");

  const allValid = name && phoneValid && emailValid && company;

  submitBtn.disabled = !allValid;
  submitBtn.style.opacity = allValid ? "1" : "0.6";
  submitBtn.style.cursor = allValid ? "pointer" : "not-allowed";

  return allValid;
}

// Live validation
[nameInput, companyInput, emailInput, phoneInput].forEach(input => {
  input.addEventListener("input", validateForm);
});

/* ============================================================
   ERPNext API FUNCTIONS (Handled in JS only)
============================================================ */
const API_HEADERS = {
  "Content-Type": "application/json",
  "Authorization": "token 33c44b17631ceb3:2d01782c6c01a7f"
};

// 1️⃣ Check Company
async function checkCompany(company) {
  const res = await fetch(`https://api.erpnext.ai/api/v2/document/Company/${company}`, {
    method: "GET",
    headers: API_HEADERS
  });

  return res.status === 200;
}

// 2️⃣ Check User
async function checkUser(email) {
  const res = await fetch(`https://api.erpnext.ai/api/v2/document/User/${email}`, {
    method: "GET",
    headers: API_HEADERS
  });

  return res.status === 200;
}

// 3️⃣ Create Company
async function createCompany(email, company, plan_id) {
  return fetch(`https://api.erpnext.ai/api/v2/document/Company/`, {
    method: "POST",
    headers: API_HEADERS,
    body: JSON.stringify({
      email_id: email,
      company_name: company,
      plan_id
    })
  });
}

// 4️⃣ Create User
async function createUser(name, email, phone, company, plan_id) {
  return fetch(`https://api.erpnext.ai/api/v2/document/User/`, {
    method: "POST",
    headers: API_HEADERS,
    body: JSON.stringify({
      email,
      first_name: name,
      company,
      role_profile_name: "Only If Create",
      phone,
      plan_id
    })
  });
}

/* ============================================================
   FREE PLAN FLOW
============================================================ */
if (freePlan) {
  submitBtn.onclick = async function () {
    if (!validateForm()) return;

    showToast("Checking details...", "info");

    const name = nameInput.value.trim();
    const email = emailInput.value.trim();
    const phone = phoneInput.value.trim();
    const company = companyInput.value.trim();

    // Company exists?
    if (await checkCompany(company)) {
      showToast("⚠️ Company already exists!", "error");
      return;
    }

    // User exists?
    if (await checkUser(email)) {
      showToast("⚠️ Email already registered!", "error");
      return;
    }

    showToast("Creating Company...", "info");
    await createCompany(email, company, 0);

    showToast("Creating User...", "info");
    await createUser(name, email, phone, company, 0);

    // Save Payment (free)
    await fetch("{% url 'save_payment' %}", {
      method: "POST",
      headers: {
        "Content-Type": "application/x-www-form-urlencoded",
        "X-CSRFToken": csrftoken
      },
      body: new URLSearchParams({
        name, email, phone, company,
        plan, amount: 0,
        status: "success"
      })
    });

    showToast("Free Plan Activated!", "success");
    setTimeout(() => { window.location.href = "https://crm.erpnext.ai"; }, 1500);
  };
}


/* ============================================================
   PAID PLAN FLOW (FINAL FIXED VERSION)
============================================================ */
if (!freePlan) {
  submitBtn.onclick = async function () {
    if (!validateForm()) return;

    showToast("Validating details...", "info");

    const name = nameInput.value.trim();
    const email = emailInput.value.trim();
    const phone = phoneInput.value.trim();
    const company = companyInput.value.trim();
    const amount = document.getElementById("amount").value;

    const plan_id = amount == "1500" ? 1500 : amount == "2500" ? 2 : 0;

    // Check Company exists
    if (await checkCompany(company)) {
      showToast("⚠️ Company already exists!", "error");
      return;
    }

    // Check User exists
    if (await checkUser(email)) {
      showToast("⚠️ Email already registered!", "error");
      return;
    }

    /* ----------------------------------------------------
       1️⃣ CREATE RAZORPAY ORDER FIRST (MANDATORY)
    ---------------------------------------------------- */
    const orderRes = await fetch("{% url 'create_order' %}", {
      method: "POST",
      headers: {
        "Content-Type": "application/x-www-form-urlencoded",
        "X-CSRFToken": csrftoken
      },
      body: new URLSearchParams({
        name, email, phone,
        plan, amount
      })
    });

    const orderData = await orderRes.json();

    if (orderData.error) {
      showToast("❌ Failed to create order", "error");
      return;
    }

    const order_id = orderData.order_id; // REQUIRED

    /* ----------------------------------------------------
       2️⃣ OPEN RAZORPAY
    ---------------------------------------------------- */
    const rzp = new Razorpay({
      key: "{{ razorpay_key }}",
      order_id: order_id,
      amount: amount * 100,
      currency: "INR",
      name: "ERPNext AI",
      description: `${plan} Subscription`,
      prefill: { name, email, contact: phone },

      handler: async function (response) {
        /* --------------------------------------------
           3️⃣ CREATE USER & COMPANY AFTER SUCCESS
        -------------------------------------------- */
        showToast("Creating Company...", "info");
        await createCompany(email, company, plan_id);

        showToast("Creating User...", "info");
        await createUser(name, email, phone, company, plan_id);

        /* --------------------------------------------
           4️⃣ SAVE PAYMENT SUCCESS
        -------------------------------------------- */
        await fetch("{% url 'save_payment' %}", {
          method: "POST",
          headers: {
            "Content-Type": "application/x-www-form-urlencoded",
            "X-CSRFToken": csrftoken
          },
          body: new URLSearchParams({
            order_id: response.razorpay_order_id,
            payment_id: response.razorpay_payment_id,
            name, email, phone, company,
            amount, plan,
            status: "success"
          })
        });

        showToast("Payment Successful!", "success");
        setTimeout(() => { window.location.href = "https://crm.erpnext.ai/app/"; }, 1500);
      },

      modal: {
        ondismiss: async function () {
          /* --------------------------------------------
             5️⃣ USER CLOSED PAYMENT (FAILED)
          -------------------------------------------- */
          await fetch("{% url 'save_payment' %}", {
            method: "POST",
            headers: {
              "Content-Type": "application/x-www-form-urlencoded",
              "X-CSRFToken": csrftoken
            },
            body: new URLSearchParams({
              order_id: order_id,
              name, email, phone, company,
              amount, plan,
              status: "failed"
            })
          });

          showToast("❌ Payment Cancelled.", "error");
        }
      }
    });

    rzp.open();
  };
}


/* ============================================================
   Restrict Phone Input
============================================================ */
phoneInput.addEventListener("input", function () {
  const value = phoneInput.value;
  if (/[^0-9]/.test(value)) {
    phoneInput.value = value.replace(/[^0-9]/g, "");
    showToast("Only numbers allowed", "error");
  }
  validateForm();
});
</script>

</body>

</html>