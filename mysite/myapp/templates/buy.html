
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Buy Now - Razorpay Demo</title>
  <script src="https://checkout.razorpay.com/v1/checkout.js"></script>

  <style>
    :root {
      --primary-bg: #001b48;
      --secondary-bg: #012e6a;
      --accent: #00b8ff;
      --btn-gradient: linear-gradient(90deg, #007bff, #00b8ff);
      --text-light: #e0e8f9;
      --white: #fff;
    }

    * { margin:0; padding:0; box-sizing:border-box; font-family:'Poppins',sans-serif; }
    body { background: linear-gradient(135deg, var(--primary-bg), var(--secondary-bg)); color: var(--white); min-height: 100vh; display:flex; align-items:center; justify-content:center; padding:20px; }
    .container { background: rgba(255,255,255,0.05); border:1px solid rgba(255,255,255,0.1); border-radius:20px; padding:40px 30px; width:100%; max-width:400px; box-shadow:0 10px 25px rgba(0,0,0,0.2); text-align:center; backdrop-filter:blur(8px); }
    .container h2 { font-size:1.6rem; font-weight:600; margin-bottom:10px; color: var(--accent); }
    .container p { font-size:0.9rem; color: var(--text-light); margin-bottom:30px; }
    .form-group { margin-bottom:18px; text-align:left; }
    label { font-size:0.9rem; color: var(--text-light); display:block; margin-bottom:6px; }
    input { width:100%; padding:10px 14px; border-radius:10px; border:none; outline:none; background: rgba(255,255,255,0.15); color:var(--white); font-size:0.95rem; transition: background 0.3s; }
    input:focus { background: rgba(255,255,255,0.25); }
    input[readonly] { background: rgba(255,255,255,0.1); cursor:not-allowed; color:#ccc; }
    .btn { width:100%; background: var(--btn-gradient); border:none; border-radius:12px; color:var(--white); font-size:1rem; font-weight:600; padding:12px 0; cursor:pointer; margin-top:10px; transition: transform 0.2s ease, opacity 0.2s ease; }
    .btn:hover { transform:translateY(-2px); opacity:0.9; }
    @media (max-width:480px) { .container { padding:30px 20px; } .container h2 { font-size:1.3rem; } }
  </style>
</head>

<body>
  <div class="container">
    <h2>Buy Product</h2>
    <p>Enter your details to proceed with the payment securely.</p>
    <form id="paymentForm">
      <div class="form-group">
        <label for="name">Full Name</label>
        <input type="text" id="name" name="name" placeholder="Enter Name" required>
      </div>

      <div class="form-group">
        <label for="email">Email ID</label>
        <input type="email" id="email" name="email" placeholder="Enter Email" required>
      </div>

      <div class="form-group">
        <label for="phone">Phone Number</label>
        <input type="text" id="phone" name="phone" placeholder="Enter Phone" required>
      </div>

      <div class="form-group">
        <label for="amount">Amount (INR)</label>
        <input type="number" id="amount" name="amount" value="1500" readonly>
      </div>

      <button type="button" id="payBtn" class="btn">Buy Now</button>
    </form>
  </div>

  <script>
    document.getElementById('payBtn').onclick = async function(e) {
      e.preventDefault();

      const name = document.getElementById('name').value.trim();
      const email = document.getElementById('email').value.trim();
      const phone = document.getElementById('phone').value.trim();
      const amount = parseInt(document.getElementById('amount').value);

      if (!name || !email || !phone) {
        alert("⚠️ Please fill all fields before proceeding.");
        return;
      }

      // 1️⃣ Create Razorpay order
      let order;
      try {
        const res = await fetch('create_order.php', {
          method: 'POST',
          headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
          body: `amount=${amount}`
        });
        order = await res.json();
        if(order.error){
          alert("Error creating order: " + order.error);
          return;
        }
      } catch(err){
        alert("Network or server error creating order.");
        console.error(err);
        return;
      }

      const options = {
        key: "rzp_test_RQ8oEOotOQ7P2E",
        amount: order.amount,
        currency: "INR",
        name: "ERPNEXT AI",
        description: "Demo Transaction",
        order_id: order.id,
        prefill: { name, email, contact: phone },
        theme: { color: "#00b8ff" },

        // 2️⃣ Success handler
        handler: async function(response) {
          const formData = new URLSearchParams();
          formData.append('payment_id', response.razorpay_payment_id);
          formData.append('order_id', order.id);
          formData.append('name', name);
          formData.append('email', email);
          formData.append('phone', phone);
          formData.append('amount', amount);

          const res = await fetch('payment_success.php', {
            method: 'POST',
            headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
            body: formData.toString()
          });

          const data = await res.json();
          console.log("Payment success:", data);
          alert("✅ Payment Successful");
        },

        // 3️⃣ Failure / cancel handler
        modal: {
          ondismiss: async function() {
            const formData = new URLSearchParams();
            formData.append('order_id', order.id || 'NA');
            formData.append('name', name);
            formData.append('email', email);
            formData.append('phone', phone);
            formData.append('amount', amount);

            const res = await fetch('payment_failed.php', {
              method: 'POST',
              headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
              body: formData.toString()
            });
            const data = await res.json();
            console.log("Payment failed:", data);
            alert("❌ Payment Cancelled or Failed");
          }
        }
      };

      const rzp = new Razorpay(options);

      // 4️⃣ Razorpay payment.failed listener
      rzp.on('payment.failed', async function(response) {
        const orderId = response.error?.metadata?.order_id || order.id || 'NA';
        const formData = new URLSearchParams();
        formData.append('order_id', orderId);
        formData.append('name', name);
        formData.append('email', email);
        formData.append('phone', phone);
        formData.append('amount', amount);

        const res = await fetch('payment_failed.php', {
          method: 'POST',
          headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
          body: formData.toString()
        });
        const data = await res.json();
        console.log("Payment failed:", data);
        alert("❌ Payment Failed");
      });

      rzp.open();
    };
  </script>
</body>
</html>
